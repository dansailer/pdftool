name: Release

# Only triggers on release publish - cannot be triggered by PRs or forks
on:
  release:
    types: [published]

permissions:
  contents: write
  packages: write
  attestations: write
  id-token: write

jobs:
  get-version:
    name: Get Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
    steps:
      - name: Get version from tag
        id: get-version
        run: |
          # Extract version from tag (remove 'v' prefix if present)
          TAG_NAME="${{ github.event.release.tag_name }}"
          VERSION="${TAG_NAME#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION from tag: $TAG_NAME"

  build-artifacts:
    name: Build Release Artifacts
    needs: get-version
    uses: ./.github/workflows/build.yml
    with:
      version: ${{ needs.get-version.outputs.version }}
    secrets: inherit

  create-release:
    name: Create GitHub Release
    needs: [get-version, build-artifacts]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Prepare release assets
        id: prepare-assets
        run: |
          VERSION="${{ needs.get-version.outputs.version }}"
          echo "Preparing release assets for version $VERSION"

          # Create a directory for the release
          mkdir -p release

          # Debug: List what we downloaded
          echo "=== Downloaded artifacts structure ==="
          find ./artifacts -type f -ls 2>/dev/null || true

          # Copy artifacts from each platform directory (now they're flat)
          if [ -d "./artifacts/macos-arm64" ]; then
            cp ./artifacts/macos-arm64/* release/ 2>/dev/null || true
          fi

          if [ -d "./artifacts/windows-amd64" ]; then
            cp ./artifacts/windows-amd64/* release/ 2>/dev/null || true
          fi

          if [ -d "./artifacts/linux-x64" ]; then
            cp ./artifacts/linux-x64/* release/ 2>/dev/null || true
          fi

          # List all files in release directory
          echo "=== Release artifacts ==="
          ls -la release/ || echo "No artifacts found"

          # Check if we have any artifacts
          if [ "$(ls -A release/ 2>/dev/null)" ]; then
            echo "has_artifacts=true" >> $GITHUB_OUTPUT
          else
            echo "has_artifacts=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate latest.json for updater
        if: steps.prepare-assets.outputs.has_artifacts == 'true'
        run: |
          VERSION="${{ needs.get-version.outputs.version }}"
          RELEASE_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # Base URL for assets
          BASE_URL="https://github.com/dansailer/pdftool/releases/download/${{ github.event.release.tag_name }}"
          
          # Initialize platforms object
          PLATFORMS="{}"
          
          echo "=== Listing release directory ==="
          ls -la release/
          
          # Note: upload-artifact converts spaces to dots in filenames
          # So we use the actual filenames from the release directory
          
          # Check for Windows NSIS installer and signature
          WINDOWS_EXE=$(find release -maxdepth 1 -name "*-setup.exe" -type f | head -1)
          if [ -n "$WINDOWS_EXE" ]; then
            WINDOWS_BASENAME=$(basename "$WINDOWS_EXE")
            # GitHub Release converts spaces to dots in filenames
            WINDOWS_URL_NAME=$(echo "$WINDOWS_BASENAME" | tr ' ' '.')
            echo "Found Windows NSIS exe: $WINDOWS_BASENAME -> URL: $WINDOWS_URL_NAME"
            if [ -f "${WINDOWS_EXE}.sig" ]; then
              WINDOWS_SIG=$(cat "${WINDOWS_EXE}.sig")
              echo "Found Windows signature"
              PLATFORMS=$(echo "$PLATFORMS" | jq --arg url "${BASE_URL}/${WINDOWS_URL_NAME}" --arg sig "$WINDOWS_SIG" \
                '. + {"windows-x86_64": {"signature": $sig, "url": $url}}')
            else
              echo "Warning: No signature file found for $WINDOWS_BASENAME"
            fi
          fi
          
          # Check for Linux AppImage and signature
          LINUX_APPIMAGE=$(find release -maxdepth 1 -name "*.AppImage" -type f | head -1)
          if [ -n "$LINUX_APPIMAGE" ]; then
            LINUX_BASENAME=$(basename "$LINUX_APPIMAGE")
            # GitHub Release converts spaces to dots in filenames
            LINUX_URL_NAME=$(echo "$LINUX_BASENAME" | tr ' ' '.')
            echo "Found Linux AppImage: $LINUX_BASENAME -> URL: $LINUX_URL_NAME"
            if [ -f "${LINUX_APPIMAGE}.sig" ]; then
              LINUX_SIG=$(cat "${LINUX_APPIMAGE}.sig")
              echo "Found Linux signature"
              PLATFORMS=$(echo "$PLATFORMS" | jq --arg url "${BASE_URL}/${LINUX_URL_NAME}" --arg sig "$LINUX_SIG" \
                '. + {"linux-x86_64": {"signature": $sig, "url": $url}}')
            else
              echo "Warning: No signature file found for $LINUX_BASENAME"
            fi
          fi
          
          # Check for macOS app and signature
          MACOS_APP=$(find release -maxdepth 1 -name "*.app.tar.gz" -type f | head -1)
          if [ -n "$MACOS_APP" ]; then
            MACOS_BASENAME=$(basename "$MACOS_APP")
            # GitHub Release converts spaces to dots in filenames
            MACOS_URL_NAME=$(echo "$MACOS_BASENAME" | tr ' ' '.')
            echo "Found macOS app: $MACOS_BASENAME -> URL: $MACOS_URL_NAME"
            if [ -f "${MACOS_APP}.sig" ]; then
              MACOS_SIG=$(cat "${MACOS_APP}.sig")
              echo "Found macOS signature"
              PLATFORMS=$(echo "$PLATFORMS" | jq --arg url "${BASE_URL}/${MACOS_URL_NAME}" --arg sig "$MACOS_SIG" \
                '. + {"darwin-aarch64": {"signature": $sig, "url": $url}}')
            else
              echo "Warning: No signature file found for $MACOS_BASENAME"
            fi
          fi
          
          # Create latest.json using jq for proper escaping
          jq -n \
            --arg version "$VERSION" \
            --arg notes "See release page for details" \
            --arg pub_date "$RELEASE_DATE" \
            --argjson platforms "$PLATFORMS" \
            '{version: $version, notes: $notes, pub_date: $pub_date, platforms: $platforms}' \
            > release/latest.json
          
          echo "=== Generated latest.json ==="
          cat release/latest.json

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: steps.prepare-assets.outputs.has_artifacts == 'true'
        with:
          tag_name: ${{ github.event.release.tag_name }}
          name: "PriskaPDF ${{ needs.get-version.outputs.version }}"
          body: |
            ## What's New

            ${{ github.event.release.body }}

            ## Downloads

            This release includes binaries for:
            - macOS (ARM64)
            - Windows (AMD64)
            - Linux (x86_64)

            Download the appropriate file for your platform from the assets below.
          files: release/*
          draft: false
          prerelease: ${{ contains(github.event.release.tag_name, 'beta') || contains(github.event.release.tag_name, 'alpha') || contains(github.event.release.tag_name, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release (No Artifacts)
        uses: softprops/action-gh-release@v2
        if: steps.prepare-assets.outputs.has_artifacts != 'true'
        with:
          tag_name: ${{ github.event.release.tag_name }}
          name: "PriskaPDF ${{ needs.get-version.outputs.version }}"
          body: |
            ## What's New

            ${{ github.event.release.body }}

            ## Downloads

            Build artifacts are being prepared. Please check back in a few minutes for downloadable binaries.

            This release will include binaries for:
            - macOS (ARM64)
            - Windows (AMD64)
            - Linux (x86_64)
          draft: false
          prerelease: ${{ contains(github.event.release.tag_name, 'beta') || contains(github.event.release.tag_name, 'alpha') || contains(github.event.release.tag_name, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}