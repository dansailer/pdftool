name: Release

# Only triggers on release publish - cannot be triggered by PRs or forks
on:
  release:
    types: [published]

permissions:
  contents: write
  packages: write
  attestations: write
  id-token: write

jobs:
  update-version:
    name: Update Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main

      - name: Get version from tag
        id: get-version
        run: |
          # Extract version from tag (remove 'v' prefix if present)
          TAG_NAME="${{ github.event.release.tag_name }}"
          VERSION="${TAG_NAME#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION from tag: $TAG_NAME"

      - name: Update version in Cargo.toml
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          sed -i "s/^version = \".*\"/version = \"$VERSION\"/" src-tauri/Cargo.toml
          echo "Updated Cargo.toml version to $VERSION"

      - name: Update version in tauri.conf.json
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" src-tauri/tauri.conf.json
          echo "Updated tauri.conf.json version to $VERSION"

      - name: Update version in package.json
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" package.json
          echo "Updated package.json version to $VERSION"

      - name: Commit version updates
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add src-tauri/Cargo.toml src-tauri/tauri.conf.json package.json
          git commit -m "chore: bump version to ${{ steps.get-version.outputs.version }}" || echo "No changes to commit"
          git push origin main

  build-artifacts:
    name: Build Release Artifacts
    needs: update-version
    uses: ./.github/workflows/build.yml
    secrets: inherit

  create-release:
    name: Create GitHub Release
    needs: [update-version, build-artifacts]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: ./artifacts

      - name: Prepare release assets
        id: prepare-assets
        run: |
          VERSION="${{ needs.update-version.outputs.version }}"
          echo "Preparing release assets for version $VERSION"

          # Create a directory for the release
          mkdir -p release

          # Copy artifacts from each platform directory
          if [ -d "./artifacts/macos-arm64" ]; then
            cp ./artifacts/macos-arm64/* release/ 2>/dev/null || true
          fi

          if [ -d "./artifacts/windows-amd64" ]; then
            cp ./artifacts/windows-amd64/* release/ 2>/dev/null || true
          fi

          if [ -d "./artifacts/linux-x64" ]; then
            cp ./artifacts/linux-x64/* release/ 2>/dev/null || true
          fi

          # List all files in release directory
          echo "Release artifacts:"
          ls -la release/ || echo "No artifacts found"

          # Check if we have any artifacts
          if [ "$(ls -A release/ 2>/dev/null)" ]; then
            echo "has_artifacts=true" >> $GITHUB_OUTPUT
          else
            echo "has_artifacts=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate latest.json for updater
        if: steps.prepare-assets.outputs.has_artifacts == 'true'
        run: |
          VERSION="${{ needs.update-version.outputs.version }}"
          RELEASE_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # Base URL for assets
          BASE_URL="https://github.com/dansailer/pdftool/releases/download/${{ github.event.release.tag_name }}"
          
          # Initialize platforms object
          PLATFORMS="{}"
          
          echo "=== Listing release directory ==="
          ls -la release/
          
          # Check for Windows NSIS installer and signature (Tauri 2 with createUpdaterArtifacts: true)
          # The format is: myapp_version_x64-setup.exe and myapp_version_x64-setup.exe.sig
          if ls release/*-setup.exe 1>/dev/null 2>&1; then
            WINDOWS_EXE=$(ls release/*-setup.exe | head -1 | xargs basename)
            echo "Found Windows NSIS exe: $WINDOWS_EXE"
            if [ -f "release/${WINDOWS_EXE}.sig" ]; then
              WINDOWS_SIG=$(cat "release/${WINDOWS_EXE}.sig")
              echo "Found Windows signature"
              PLATFORMS=$(echo "$PLATFORMS" | jq --arg url "${BASE_URL}/${WINDOWS_EXE}" --arg sig "$WINDOWS_SIG" \
                '. + {"windows-x86_64": {"signature": $sig, "url": $url}}')
            else
              echo "Warning: No signature file found for $WINDOWS_EXE"
            fi
          # Fallback: Check for NSIS zip format (v1Compatible mode)
          elif ls release/*.nsis.zip 1>/dev/null 2>&1; then
            WINDOWS_ZIP=$(ls release/*.nsis.zip | head -1 | xargs basename)
            echo "Found Windows NSIS zip: $WINDOWS_ZIP"
            if [ -f "release/${WINDOWS_ZIP}.sig" ]; then
              WINDOWS_SIG=$(cat "release/${WINDOWS_ZIP}.sig")
              echo "Found Windows signature"
              PLATFORMS=$(echo "$PLATFORMS" | jq --arg url "${BASE_URL}/${WINDOWS_ZIP}" --arg sig "$WINDOWS_SIG" \
                '. + {"windows-x86_64": {"signature": $sig, "url": $url}}')
            else
              echo "Warning: No signature file found for $WINDOWS_ZIP"
            fi
          fi
          
          # Check for Linux AppImage and signature
          if ls release/*.AppImage 1>/dev/null 2>&1; then
            LINUX_APPIMAGE=$(ls release/*.AppImage | head -1 | xargs basename)
            echo "Found Linux AppImage: $LINUX_APPIMAGE"
            if [ -f "release/${LINUX_APPIMAGE}.sig" ]; then
              LINUX_SIG=$(cat "release/${LINUX_APPIMAGE}.sig")
              echo "Found Linux signature"
              PLATFORMS=$(echo "$PLATFORMS" | jq --arg url "${BASE_URL}/${LINUX_APPIMAGE}" --arg sig "$LINUX_SIG" \
                '. + {"linux-x86_64": {"signature": $sig, "url": $url}}')
            else
              echo "Warning: No signature file found for $LINUX_APPIMAGE"
            fi
          fi
          
          # Check for macOS app and signature
          if ls release/*.app.tar.gz 1>/dev/null 2>&1; then
            MACOS_APP=$(ls release/*.app.tar.gz | head -1 | xargs basename)
            echo "Found macOS app: $MACOS_APP"
            if [ -f "release/${MACOS_APP}.sig" ]; then
              MACOS_SIG=$(cat "release/${MACOS_APP}.sig")
              echo "Found macOS signature"
              PLATFORMS=$(echo "$PLATFORMS" | jq --arg url "${BASE_URL}/${MACOS_APP}" --arg sig "$MACOS_SIG" \
                '. + {"darwin-aarch64": {"signature": $sig, "url": $url}}')
            else
              echo "Warning: No signature file found for $MACOS_APP"
            fi
          fi
          
          # Create latest.json using jq for proper escaping
          jq -n \
            --arg version "$VERSION" \
            --arg notes "See release page for details" \
            --arg pub_date "$RELEASE_DATE" \
            --argjson platforms "$PLATFORMS" \
            '{version: $version, notes: $notes, pub_date: $pub_date, platforms: $platforms}' \
            > release/latest.json
          
          echo "=== Generated latest.json ==="
          cat release/latest.json

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: steps.prepare-assets.outputs.has_artifacts == 'true'
        with:
          tag_name: ${{ github.event.release.tag_name }}
          name: "PriskaPDF ${{ needs.update-version.outputs.version }}"
          body: |
            ## What's New

            ${{ github.event.release.body }}

            ## Downloads

            This release includes binaries for:
            - macOS (ARM64)
            - Windows (AMD64)
            - Linux (x86_64)

            Download the appropriate file for your platform from the assets below.
          files: release/*
          draft: false
          prerelease: ${{ contains(github.event.release.tag_name, 'beta') || contains(github.event.release.tag_name, 'alpha') || contains(github.event.release.tag_name, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release (No Artifacts)
        uses: softprops/action-gh-release@v2
        if: steps.prepare-assets.outputs.has_artifacts != 'true'
        with:
          tag_name: ${{ github.event.release.tag_name }}
          name: "PriskaPDF ${{ needs.update-version.outputs.version }}"
          body: |
            ## What's New

            ${{ github.event.release.body }}

            ## Downloads

            Build artifacts are being prepared. Please check back in a few minutes for downloadable binaries.

            This release will include binaries for:
            - macOS (ARM64)
            - Windows (AMD64)
            - Linux (x86_64)
          draft: false
          prerelease: ${{ contains(github.event.release.tag_name, 'beta') || contains(github.event.release.tag_name, 'alpha') || contains(github.event.release.tag_name, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}